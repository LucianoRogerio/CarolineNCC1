---
title: "Diversidade Genetica"
author: "LucianoRogerio"
date: "2021-11-08"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Shannon Weaver Index estimation for each core collection

### Shannon Weaver Index Quantitative traits

```{r}
suppressMessages(library(tidyverse)); suppressMessages(library(data.table)); suppressMessages(library(reactable))
source(here::here("code", "Shannon-Weaver.R"))
Alldataset <- readRDS(here::here("output", "AllDataCCCaroline.RDS"))

QualityTrait <- colnames(Alldataset)[2:36]


AlldataSetQuant <- Alldataset %>% select(-all_of(QualityTrait))
AlldataSetQuali <- Alldataset %>% select(Acessos, QualityTrait, Data, Method) %>% suppressMessages()

QuantTrait <- data.frame(Trait = colnames(AlldataSetQuant)[2:17],
                         Min = apply(AlldataSetQuant[2:17], FUN = min, na.rm = TRUE, MARGIN = 2),
                         Max = apply(AlldataSetQuant[2:17], FUN = max, na.rm = TRUE, MARGIN = 2))
DataMethod <- unique(data.frame(Data = AlldataSetQuant$Data,
                                Method = AlldataSetQuant$Method))

QuantSHs <- NULL
for(i in 1:nrow(DataMethod)){
  for(trait in QuantTrait$Trait){
    QuantSH <- data.frame(Data = DataMethod$Data[i],
                          Method = DataMethod$Method[i],
                          Trait = trait,
                          SH = Shannon.Weaver.QT(AlldataSetQuant[(AlldataSetQuant$Data%in%DataMethod$Data[i] &
                                                                    AlldataSetQuant$Method%in%DataMethod$Method[i]),trait],
                                                 Min = QuantTrait[QuantTrait$Trait == trait, "Min"],
                                                 Max = QuantTrait[QuantTrait$Trait == trait, "Max"],
                                                 formula = 2))
    QuantSHs <- rbind(QuantSHs, QuantSH)
  }
}

Table1SH <- matrix(QuantSHs$SH, byrow = F, ncol = 13)
rownames(Table1SH) <- unique(QuantSHs$Trait)
colnames(Table1SH) <- unique(paste(QuantSHs$Data, QuantSHs$Method, sep = " - "))
colnames(Table1SH)[1] <- "BAG"

write.table(Table1SH, file = here::here("output", "Shannon-WeaverCCQuantIndex.csv"),
            sep = ",", dec = ".", quote = FALSE)
```


#### **Table 1.** Shannon-Weaver indexes for Cassava quantitative traits of the Bank of germplasm and 12 nuclear core collections.
```{r, echo = FALSE}
Table1SH %>% reactable(defaultPageSize = 16, columns = list(
  BAG = colDef(format = colFormat(digits = 3, locales = "en-US")),
  'Pheno - GW/CH' = colDef(format = colFormat(digits = 3, locales = "en-US")),
  'Pheno - CH' = colDef(format = colFormat(digits = 3, locales = "en-US")),
  'Pheno - GW/MLST' = colDef(format = colFormat(digits = 3, locales = "en-US")),
  'Geno - MR/SH' = colDef(format = colFormat(digits = 3, locales = "en-US")),
  'Geno - CE/SH' = colDef(format = colFormat(digits = 3, locales = "en-US")),
  'Geno - MR/EH' = colDef(format = colFormat(digits = 3, locales = "en-US")),
  'Geno - CE/EH' = colDef(format = colFormat(digits = 3, locales = "en-US")),
  'Geno - MR/AC' = colDef(format = colFormat(digits = 3, locales = "en-US")),
  'Geno - CE/AC' = colDef(format = colFormat(digits = 3, locales = "en-US")),
  'Geno - AM/MLST' = colDef(format = colFormat(digits = 3, locales = "en-US")),
  'Geno - MR/MLST' = colDef(format = colFormat(digits = 3, locales = "en-US")),
  'Geno - CE/MLST' = colDef(format = colFormat(digits = 3, locales = "en-US"))))
```

### Shannon Weaver Index Qualitative traits

```{r}

Trait <- c("CorFolhaApical" = 4, "CorPeciolo" = 6, "CorFolhaDesenv" = 5,
           "CorNerv" = 4, "CorCortexCaule" = 4, "CorExternaCaule" = 7,
           "CorEpidCaule" = 4, "CorRamosTerm" = 3, "CorExternaRzs" = 4,
           "CorCortexRzs" = 4, "CorPolpaRzs" = 5, "NLobulos" = 5,
           "Pubescencia" = 2, "FormaLobuloCentral" = 9, "PosicaoPeciolo" = 4,
           "Sinuosidade" = 2, "ComprEstip" = 2, "HabCresCaule" = 2,
           "TipoPlan" = 4, "MargEstip" = 2, "HabRamif" = 4, "NiveisRam" = 4, 
           "ProemCicatrizesFolhas" = 2, "FormaRzs" = 4, "TxtEpidermeRzs" = 2,
           "PresPedunculoRzs" = 3, "PosicaoRzs" = 3, "Flowering" = 2,
           "DestqPelicRz" = 2, "DestqCortexRz" = 3, "ConstrRzs" = 3,
           "ComprFilotaxia" = 3, "AnguloRamif" = 22, "PorteMod" = 5, 
           "HCNMod" = 9)

QualTrait <- data.frame(Trait = names(Trait),
                        NClas = Trait,
                        row.names = NULL)

QualSHs <- NULL
for(i in 1:nrow(DataMethod)){
  for(trait in QualTrait$Trait) {
    QualSH <- data.frame(Data = DataMethod$Data[i],
                         Method = DataMethod$Method[i],
                         Trait = trait,
                         SH = Shannon.Weaver.QL(as.character(AlldataSetQuali[(AlldataSetQuali$Data%in%DataMethod$Data[i] &
                                                                    AlldataSetQuali$Method%in%DataMethod$Method[i]),trait]),
                                                nclass = QualTrait$NClas[QualTrait$Trait%in%trait]))
    QualSHs <- rbind(QualSHs, QualSH)
  }
}

Table2SH <- matrix(QualSHs$SH, byrow = F, ncol = 13)
rownames(Table2SH) <- unique(QualSHs$Trait)
colnames(Table2SH) <- unique(paste(QualSHs$Data, QualSHs$Method, sep = " - "))
colnames(Table2SH)[1] <- "BAG"

write.table(Table2SH, file = here::here("output", "Shannon-WeaverCCQualIndex.csv"),
            sep = ",", dec = ".", quote = FALSE)

SHInd <- as.data.frame(rbind(Table1SH, Table2SH))
```


#### **Table 2.** Shannon-Weaver indexes for Cassava quality traits of the Bank of germplasm and 12 nuclear core collections.
```{r, echo = FALSE}
Table2SH %>% reactable(defaultPageSize = 15, columns = list(
  BAG = colDef(format = colFormat(digits = 3, locales = "en-US")),
  'Pheno - GW/CH' = colDef(format = colFormat(digits = 3, locales = "en-US")),
  'Pheno - CH' = colDef(format = colFormat(digits = 3, locales = "en-US")),
  'Pheno - GW/MLST' = colDef(format = colFormat(digits = 3, locales = "en-US")),
  'Geno - MR/SH' = colDef(format = colFormat(digits = 3, locales = "en-US")),
  'Geno - CE/SH' = colDef(format = colFormat(digits = 3, locales = "en-US")),
  'Geno - MR/EH' = colDef(format = colFormat(digits = 3, locales = "en-US")),
  'Geno - CE/EH' = colDef(format = colFormat(digits = 3, locales = "en-US")),
  'Geno - MR/AC' = colDef(format = colFormat(digits = 3, locales = "en-US")),
  'Geno - CE/AC' = colDef(format = colFormat(digits = 3, locales = "en-US")),
  'Geno - AM/MLST' = colDef(format = colFormat(digits = 3, locales = "en-US")),
  'Geno - MR/MLST' = colDef(format = colFormat(digits = 3, locales = "en-US")),
  'Geno - CE/MLST' = colDef(format = colFormat(digits = 3, locales = "en-US"))))
```


## Core Collection Selection - Phenotypic data
```{r}
SHBAG <- SHInd[, "BAG"]
SHIndPhen <- SHInd[ , colnames(SHInd)%like%"Pheno"]

SHRelPhen <- (SHIndPhen - SHBAG)*100/SHBAG

SHSelPhen <- data.frame(Method = colnames(SHRelPhen),
                        SHMeanImprov = colMeans(SHRelPhen, na.rm = TRUE),
                        SHsd = apply(SHRelPhen, FUN = sd, na.rm = TRUE, MARGIN = 2),
                        row.names = NULL)
```

#### **Table 3.** Mean improvement of the Shannon-Weaver diversity index in % of nuclear core collections estimated of Phenotypic data compared to the Bank of Germplasm
```{r, echo = FALSE}
reactable(SHSelPhen, columns = list(
  SHMeanImprov = colDef(format = colFormat(digits = 3, locales = "en-US")),
  SHsd = colDef(format = colFormat(digits = 3, locales = "en-US"))))

```

The phenotypic Core Collection selected was GW/CH

## Core Collection Selection - Genotypic data
```{r}
SHIndGen <- SHInd[ , colnames(SHInd)%like%"Geno"]

SHRelGen <- (SHIndGen - SHBAG)*100/SHBAG

SHSelGen <- data.frame(Method = colnames(SHRelGen),
                        SHMeanImprov = colMeans(SHRelGen, na.rm = TRUE),
                        SHsd = apply(SHRelGen, FUN = sd, na.rm = TRUE, MARGIN = 2),
                        row.names = NULL)
```

#### **Table 4.** Mean improvement of the Shannon-Weaver diversity index in % of nuclear core collections estimated of Genotypic data compared to the Bank of Germplasm
```{r, echo = FALSE}
reactable(SHSelGen, columns = list(
  SHMeanImprov = colDef(format = colFormat(digits = 3, locales = "en-US")),
  SHsd = colDef(format = colFormat(digits = 3, locales = "en-US"))))

```

The Genotypic Core Collection selected was AM/MLST

## Comparison of the diversity Between BAG and the Core Collections samples

```{r}
suppressMessages(library(StatMatch)); library(here)
suppressMessages(library(tidyverse))

DataCar <- read.table(here::here("data", "DadosSelCaroline.CSV"), header = T, sep = ",", dec = ".",
                      na.strings = "NA", colClasses =  c("factor",
                                                        rep("character", times = 24),
                                                        rep("numeric", times = 27)))

DistCar <- gower.dist(data.x = DataCar[,-1])
row.names(DistCar) <- colnames(DistCar) <- DataCar$Acessos
PCA <- prcomp(DistCar)

Perc <- 100*PCA$sdev^2/sum(PCA$sdev^2)
PercAc <- as.vector(rep(NA, times = length(Perc)))
for(i in 1:length(Perc)) {
  PercAc[i] <- sum(Perc[1:i])
  names(PercAc)[i] <- i
}
```

#### **Fig 1.** Accumulated Variance explained by PCA
```{r, echo = FALSE}
barplot(PercAc[1:15], main = "Variance explained by PCA",
        ylab = "Cumulative variance (%)", xlab = "Number of retained PCs",
        col = c("gray"), ylim = c(0, 100))
```

```{r}
PointPCA1 <- as.data.frame(PCA$x[,1:5])

Alldataset <- readRDS(here::here("output", "AllDataCCCaroline.RDS"))
CCPhen <- Alldataset %>% filter(Data == "Pheno", Method == "GW/CH") %>%
  select(Acessos) 
CCPhen$Acessos <- CCPhen$Acessos %>% gsub(pattern = "\xed", replacement = "i") %>%
  gsub(pattern = "\xc3", replacement = "A") %>%
  gsub(pattern = "\xe1", replacement = "a") %>%
  gsub(pattern = "\xe3", replacement = "a")

CCGen  <- Alldataset %>% filter(Data == "Geno", Method == "AM/MLST") %>%
  select(Acessos)
CCGen$Acessos <- CCGen$Acessos %>% gsub(pattern = "\xed", replacement = "i")

PointPCA1$Sample <- rep(NA, nrow(PointPCA1))

for(i in row.names(PointPCA1)){
  if(i%in%CCPhen$Acessos && i%in%CCGen$Acessos) {
    PointPCA1$Sample[row.names(PointPCA1)==i] <- "Both"
  } else if(i%in%CCPhen$Acessos && !i%in%CCGen$Acessos){
    PointPCA1$Sample[row.names(PointPCA1)==i] <- "GW/CH"
  } else if(!i%in%CCPhen$Acessos && i%in%CCGen$Acessos){
    PointPCA1$Sample[row.names(PointPCA1)==i] <- "AM/MLST"
  } else {
    PointPCA1$Sample[row.names(PointPCA1)==i] <- "NS"
  }
}
```

```{r}
PC12 <- ggplot(data = PointPCA1, aes(x = PC1, y = PC2)) +
  geom_point(aes(color = Sample, shape = Sample)) +
  geom_rug(col = "steelblue", alpha = 0.2, size = 1.5) +
  scale_shape_manual(values = c(16, 16, 16, 1)) +
  scale_color_manual(values = c("blue", "purple", "red", "gray")) +
  stat_ellipse(geom="polygon", 
               alpha = 0.2, 
               show.legend = FALSE, 
               level = 0.95) +
  xlab("PC1 - 31.07%") + ylab("PC2 - 12.42%")

PC34 <- ggplot(data = PointPCA1, aes(x = PC3, y = PC4)) +
  geom_point(aes(color = Sample, shape = Sample)) +
  geom_rug(col = "steelblue", alpha = 0.2, size = 1.5) +
  scale_shape_manual(values = c(16, 16, 16, 1)) +
  scale_color_manual(values = c("blue", "purple", "red", "gray")) +
  stat_ellipse(geom="polygon", 
               alpha = 0.2, 
               show.legend = FALSE, 
               level = 0.95) +
  xlab("PC3 - 8.25%") + ylab("PC4 - 6.12%")
```

#### **Fig 2.** Análise de Componentes Principais da Matriz de Distância de Gower dos acessos do Banco ativo de germoplasma da EMBRAPA Selecionados pelas Coleções Nucleares GW/CH e AM/MLST
```{r, echo = FALSE}
library(ggpubr)
ggarrange(PC12, PC34, common.legend = T, legend = "right", ncol = 1)
```

Back - [Análises Descritivas](AnDis.html)

[Home](index.html)
